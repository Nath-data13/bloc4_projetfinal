pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = 'eu-west-3' // Région pour la Corse/France
    }

    stages {
        stage('Checkout') {
            steps {
                // Télécharge le code depuis GitHub
                checkout scm
            }
        }

        stage('Docker sanity check') {
            steps {
                sh '''
                    echo "=== Vérification de Docker ==="
                    docker --version
                    docker ps
                '''
            }
        }

        stage('Build Docker image') {
            steps {
                // On build l'image en utilisant le Dockerfile qui est dans airflow-feu
                sh 'docker build -t fire-tests ./airflow_feu'
            }
        }
        stage('Run tests') {
            steps {
                withCredentials([
                    string(credentialsId: 'AWS_ACCESS_KEY_ID', variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'AWS_SECRET_ACCESS_KEY', variable: 'AWS_SECRET_ACCESS_KEY'),
                    string(credentialsId: 'AWS_BUCKET_NAME', variable: 'AWS_BUCKET_NAME'),
                    string(credentialsId: 'BACKEND_STORE_URI', variable: 'BACKEND_STORE_URI'),
                    string(credentialsId: 'MLFLOW_TRACKING_URI', variable: 'MLFLOW_TRACKING_URI')
                ]) {
                    sh '''
                        echo "=== Nettoyage et Lancement des tests ==="
                        docker rm -f fire-tests-container || true

                        # 1. Création du conteneur avec l'utilisateur root pour éviter les soucis de permissions
                        docker create --name fire-tests-container \
                          -u root \
                          --entrypoint="" \
                          -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_BUCKET_NAME \
                          -e DATABASE_URL -e MLFLOW_TRACKING_URI \
                          fire-tests \
                          bash -c "find . -name '__pycache__' -type d -exec rm -rf {} + && python3 -m py_compile airflow_feu/dags/*.py && python -m pytest tests/test_imports.py --junitxml=pytest-report.xml"
                        
                        # 2. Copie du projet
                        docker cp . fire-tests-container:/opt/airflow/

                        # 3. Lancement
                        echo "=== Vérification Syntaxique et Tests de Connexion ==="
                        docker start -a fire-tests-container
                    '''
                }
            }
        }
        // stage('Run tests') {
        //     steps {
        //         withCredentials([
        //             string(credentialsId: 'AWS_ACCESS_KEY_ID', variable: 'AWS_ACCESS_KEY_ID'),
        //             string(credentialsId: 'AWS_SECRET_ACCESS_KEY', variable: 'AWS_SECRET_ACCESS_KEY'),
        //             string(credentialsId: 'AWS_BUCKET_NAME', variable: 'AWS_BUCKET_NAME'),
        //             string(credentialsId: 'DATABASE_URL', variable: 'DATABASE_URL'),
        //             string(credentialsId: 'MLFLOW_TRACKING_URI', variable: 'MLFLOW_TRACKING_URI')
        //         ]) {
        //             sh '''
        //                 echo "=== Nettoyage et Lancement des tests ==="
        //                 docker rm -f fire-tests-container || true

        //                 # 1. Création du conteneur
        //                 docker create --name fire-tests-container \
        //                   --entrypoint="" \
        //                   -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_BUCKET_NAME \
        //                   -e DATABASE_URL -e MLFLOW_TRACKING_URI \
        //                   fire-tests \
        //                   bash -c "python3 -m py_compile airflow_feu/dags/*.py && python -m pytest tests/test_imports.py --junitxml=pytest-report.xml"
                        
        //                 # 2. Copie de TOUT le projet pour la vérification des DAGs
        //                 docker cp . fire-tests-container:/opt/airflow/

        //                 # 3. Lancement
        //                 echo "=== Vérification Syntaxique et Tests de Connexion ==="
        //                 docker start -a fire-tests-container
        //             '''
        //         }
        //     }
        // }
        // stage('Run tests') {
        //     steps {
        //         withCredentials([
        //             string(credentialsId: 'AWS_ACCESS_KEY_ID', variable: 'AWS_ACCESS_KEY_ID'),
        //             string(credentialsId: 'AWS_SECRET_ACCESS_KEY', variable: 'AWS_SECRET_ACCESS_KEY'),
        //             string(credentialsId: 'AWS_BUCKET_NAME', variable: 'AWS_BUCKET_NAME')
        //         ]) {
        //             sh '''
        //                 echo "=== Préparation du conteneur de test ==="
        //                 docker rm -f fire-tests-container || true
                        
        //                 # 1. On crée le conteneur sans le lancer (pour pouvoir copier dedans)
        //                 docker create --name fire-tests-container \
        //                   --entrypoint "" \
        //                   -e CI=true \
        //                   -e AWS_ACCESS_KEY_ID \
        //                   -e AWS_SECRET_ACCESS_KEY \
        //                   -e AWS_DEFAULT_REGION \
        //                   -e AWS_BUCKET_NAME \
        //                   fire-tests \
        //                   python -m pytest tests/test_imports.py --junitxml=pytest-report.xml

        //                 # 2. On envoie physiquement le dossier tests dans le conteneur
        //                 docker cp tests fire-tests-container:/opt/airflow/

        //                 # 3. On lance le conteneur
        //                 echo "=== Lancement de Pytest ==="
        //                 docker start -a fire-tests-container
        //             '''
        //         }
        //     }
        // }


        stage('Collect Results') {
            steps {
                sh '''
                    echo "=== Récupération du rapport de test ==="
                    mkdir -p pytest-reports
                    docker cp fire-tests-container:/opt/airflow/pytest-report.xml pytest-reports/pytest-report.xml
                    docker rm fire-tests-container
                '''
                // Affiche le résultat des tests graphiquement dans Jenkins
                junit testResults: 'pytest-reports/pytest-report.xml'
            }
        }
    }

    post {
        success { echo '✅ Super ! Le code est validé et les tests sont au vert.' }
        failure { echo '❌ Attention, les tests ont échoué. Vérifie tes imports ou tes accès AWS.' }
    }
}